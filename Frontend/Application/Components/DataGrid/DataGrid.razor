@namespace Hephaestus.Frontend.Application.Components
@inherits Microsoft.AspNetCore.Components.ComponentBase
@using System.Text.Json
@typeparam TEntity

<RadzenStack Style="height: 100%">

	<!-- Header -->
	<RadzenRow AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceAround">
		<RadzenColumn>
			<RadzenText Text="Usuários Cadastrados" TextStyle="TextStyle.H5" TagName="TagName.H5" style="margin: 0" />
		</RadzenColumn>
		<RadzenColumn>
			<RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.End" Gap="0.5rem">
				<RadzenButton Icon="add_circle_outline" Text="Add" Variant="Variant.Flat" />
			</RadzenStack>
		</RadzenColumn>
	</RadzenRow>

	<!-- DataGrid -->
	<RadzenRow Style="height: 100%">
		<RadzenColumn SizeMD=12>
			<RadzenDataGrid @ref="grid" Data="@data" Count="@count" IsLoading=@loading LoadData="@GridLoadData" TItem="TEntity" @bind-Settings=@Settings Style="height: 100%"
											AllowFiltering="true" FilterMode="FilterMode.Advanced" AllowColumnPicking="true" AllowColumnReorder="true" AllowColumnResize="true" AllowGrouping="true"
											AllowRowSelectOnRowClick="true" ShowCellDataAsTooltip="true" ShowColumnTitleAsTooltip="true" AllowMultiColumnSorting="true" ShowMultiColumnSortingIndex="false" Responsive="false"
											AllowPaging="true" AllowSorting="true" ShowPagingSummary="true" PagerAlwaysVisible="true" PageSizeOptions=@pagesizes PageSize=@pagesize
											AllColumnsText=@AppTexts["0078"] ColumnsText=@AppTexts["0079"] ColumnsShowingText=@AppTexts["0080"]
											FilterText=@AppTexts["0081"] ApplyFilterText=@AppTexts["0082"] ClearFilterText=@AppTexts["0083"] EnumFilterSelectText=@AppTexts["0084"] EnumNullFilterText=@AppTexts["0085"]
											StartsWithText=@AppTexts["0086"] EndsWithText=@AppTexts["0087"] ContainsText=@AppTexts["0088"] DoesNotContainText=@AppTexts["0089"] EqualsText=@AppTexts["0090"] NotEqualsText=@AppTexts["0091"]
											GreaterThanText=@AppTexts["0092"] GreaterThanOrEqualsText=@AppTexts["0093"] LessThanText=@AppTexts["0094"] LessThanOrEqualsText=@AppTexts["0095"]
											IsEmptyText=@AppTexts["0096"] IsNotEmptyText=@AppTexts["0097"] IsNullText=@AppTexts["0098"] IsNotNullText=@AppTexts["0099"]
											AndOperatorText=@AppTexts["0100"] OrOperatorText=@AppTexts["0101"]
											PageTitleFormat=@AppTexts["0102"] PageSizeText=@AppTexts["0103"]
											PageAriaLabelFormat=@AppTexts["0104"] PagingSummaryFormat=@AppTexts["0105"]
											NextPageTitle=@AppTexts["0106"] NextPageAriaLabel=@AppTexts["0107"]
											PrevPageTitle=@AppTexts["0108"] PrevPageAriaLabel=@AppTexts["0109"]
											FirstPageTitle=@AppTexts["0110"] FirstPageAriaLabel=@AppTexts["0111"]
											LastPageTitle=@AppTexts["0112"] LastPageAriaLabel=@AppTexts["0113"]
											FilterOperatorArialLabel=@AppTexts["0114"] SecondFilterOperatorArialLabel=@AppTexts["0115"]
											FilterValueArialLabel=@AppTexts["0116"] SecondFilterValueArialLabel=@AppTexts["0117"]
											LogicalOperatorArialLabel=@AppTexts["0118"] SelectVisibleColumnsArialLabel=@AppTexts["0119"]
											ExpandGroupAriaLabel=@AppTexts["0120"] ExpandChildItemAriaLabel=@AppTexts["0121"] RemoveGroupArialLabel=@AppTexts["0122"]
											GroupPanelText=@AppTexts["0123"] EmptyText=@AppTexts["0124"] FilterDateFormat=@AppFormats["DateTimeShort"]>

				<Columns>
					@ChildContent
				</Columns>

			</RadzenDataGrid>
		</RadzenColumn>
	</RadzenRow>
</RadzenStack>

@code {

	[Parameter]
	public string Name { get; set; } = $"{typeof(TEntity).Name}s";

	[Parameter]
	public string Title { get; set; } = $"Data Grid of {typeof(TEntity).Name}s";

	[Parameter]
	public string SourceTable { get; set; } = $"{typeof(TEntity).Name}s";

	[Parameter]
	public string SourceExpand { get; set; } = default!;

	[Parameter]
	public string SourceFilter { get; set; } = default!;

	[Parameter]
	public string SourceOrder { get; set; } = default!;

	[Parameter]
	public RenderFragment? ChildContent { get; set; }

	private RadzenDataGrid<TEntity>? grid;
	private IEnumerable<TEntity>? data;
	private bool loading;
	private int count;

	private async Task GridLoadData(LoadDataArgs args) {

		try {

			loading = true;
			await Task.Yield();

			var result = await DatabaseService.GetItemsAsync<TEntity>(table: SourceTable, expand: SourceExpand, filter: $"{args.Filter}", orderby: $"{args.OrderBy}", top: args.Top, skip: args.Skip, count: args.Top != null && args.Skip != null);
			data = result.Value.AsODataEnumerable();
			count = result.Count;

		} catch (Exception) {

			NotificationService.Notify(new NotificationMessage() { Severity = NotificationSeverity.Error, Summary = $"Error", Detail = $"Unable to load Users" });

		} finally {

			loading = false;

		}

	}

	private int pagesize = 25;
	private IEnumerable<int> pagesizes = new int[] { 25, 50, 75, 100 };
	private DataGridSettings? settings;

	private DataGridSettings Settings {
		get { return settings ?? default!; }
		set {
			if (settings != value) {
				settings = value;
				InvokeAsync(SaveStateAsync);
			}
		}
	}

	protected override async Task OnAfterRenderAsync(bool firstRender) {

		if (firstRender) await LoadStateAsync();

	}

	private async Task LoadStateAsync() {

		var result = await JSRuntime.InvokeAsync<string>("window.localStorage.getItem", $"DataGridSettings_{Name}");

		if (!string.IsNullOrEmpty(result) && result != "null") {

			settings = JsonSerializer.Deserialize<DataGridSettings>(result);

			if (settings is not null && settings.PageSize.HasValue) {

				pagesize = settings.PageSize.Value;
				await Task.Yield();

			}

		}

	}

	private async Task SaveStateAsync() {

		await JSRuntime.InvokeVoidAsync("window.localStorage.setItem", $"DataGridSettings_{Name}", JsonSerializer.Serialize<DataGridSettings>(Settings));

	}

	private void LoadSettings(DataGridLoadSettingsEventArgs args) {

		if (Settings != null) args.Settings = Settings;

	}

}